<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏≤ ‡∏°‡∏≠ ‡∏≠‡∏≠ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ï‡∏£‡∏±‡∏á</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CORE STYLES --- */
        :root {
            --primary: #0056b3;       /* ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô */
            --primary-light: #eff6ff;
            --secondary: #0ea5e9;     /* ‡∏ü‡πâ‡∏≤‡∏™‡∏î‡πÉ‡∏™ */
            --text-main: #334155;
            --text-light: #64748b;
            --bg-body: #f1f5f9;
            --card-radius: 16px;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding-bottom: 60px;
        }

        /* --- HEADER --- */
        .header-section {
            background: linear-gradient(135deg, #0f172a 0%, #1e40af 100%); /* ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°-‡∏î‡∏≥ ‡∏î‡∏π‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£ */
            padding: 1.5rem 1rem 3rem 1rem;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            z-index: 10;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .shop-logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
            background: white;
            border-radius: 50%;
            padding: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* --- MENU CARDS (Flashcards) --- */
        .dashboard-container {
            max-width: 1200px;
            margin: -25px auto 0; /* ‡∏î‡∏∂‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏ó‡∏±‡∏ö Header ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
            padding: 0 1rem;
            position: relative;
            z-index: 20;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 2rem;
        }

        .menu-card {
            background: white;
            border-radius: var(--card-radius);
            padding: 1.25rem 1rem;
            text-align: center;
            text-decoration: none;
            color: var(--text-main);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            cursor: pointer;
        }

        .menu-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: var(--secondary);
        }

        .icon-box {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: white; /* ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß ‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ */
        }

        .menu-title {
            font-size: 0.95rem;
            font-weight: 500;
            line-height: 1.3;
        }

        /* --- BUTTONS --- */
        .btn-action {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-action:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.15); }
        .btn-action:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-blue { background-color: #2563eb; color: white; }
        .btn-blue:hover { background-color: #1d4ed8; }

        .btn-green { background-color: #16a34a; color: white; }
        .btn-green:hover { background-color: #15803d; }

        .btn-red { background-color: #dc2626; color: white; }
        .btn-red:hover { background-color: #b91c1c; }

        .btn-gray { background-color: #64748b; color: white; }
        .btn-gray:hover { background-color: #475569; }

        /* --- FORM --- */
        .form-section {
            background: white;
            border-radius: var(--card-radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid #f1f5f9;
        }

        .input-field, .select-field, .textarea-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            background-color: #f8fafc;
            font-family: 'Kanit', sans-serif;
            transition: border-color 0.2s;
        }
        .input-field:focus, .select-field:focus, .textarea-field:focus {
            outline: none;
            border-color: var(--primary);
            background-color: white;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* --- TABLE --- */
        .modern-table thead th {
            background-color: #f8fafc;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .modern-table tbody tr {
            border-bottom: 1px solid #f1f5f9;
        }
        .modern-table tbody tr:last-child { border-bottom: none; }
        .modern-table tbody tr:hover { background-color: #f8fafc; }
        .modern-table td { padding: 1rem; vertical-align: middle; }

        /* --- PRINT --- */
        @media print {
            .header-section, .no-print, footer, .dashboard-container { display: none !important; }
            body { background-color: white !important; padding: 0; }
            #view-area { display: none !important; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0.5cm; }
            .report-table td, .spsr-table td { border-color: #000 !important; page-break-inside: avoid; }
            .report-table .header-row { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script> 
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        // --- FIREBASE CONFIG & LOGIC (KEEP ORIGINAL) ---
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyB1ixH1epK4fnaLLbO10wsH_LTDDhraoyg",
            authDomain: "casereportcmo.firebaseapp.com",
            projectId: "casereportcmo",
            storageBucket: "casereportcmo.firebasestorage.app",
            messagingSenderId: "588025239095",
            appId: "1:588025239095:web:9d98aaf31e903546da91b2"
        };
        const FIREBASE_PATH_APP_ID = 'trang-case-system'; 
        const APPS_SCRIPT_RECORD_URL = 'https://script.google.com/macros/s/AKfycbxvb717wxqHcUZVOi8xMSs-ICDa7DydwtDsfwHLMoF-F1V_eeCyI89ZD119uzkP3rifeg/exec'; 
        const DRIVE_UPLOAD_CASE_URL = 'https://drive.google.com/drive/u/0/folders/1LXVLw5lorx7lrD4mfbTw39BscTIVdNOd'; 
        const DRIVE_REFERRAL_UPLOAD_URL = 'https://drive.google.com/drive/u/0/folders/1XO8lG3AWtksKGxb0qBxYtiKilkO5cENM'; 
        const LOGO_BASE_URL = './head refer form.jpg'; 
        const SHOP_LOGO_URL = '‡∏ï‡∏£‡∏≤.png'; // New Shop Logo

        const branchMap = { '1': '‡∏™‡∏≤‡∏Ç‡∏≤ 1 ‡∏ô‡∏≤‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏û‡∏ä‡∏£', '2': '‡∏™‡∏≤‡∏Ç‡∏≤ 2 ‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏á', '3': '‡∏™‡∏≤‡∏Ç‡∏≤ 3 ‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏á', '4': '‡∏™‡∏≤‡∏Ç‡∏≤ 4 ‡∏ô‡∏≤‡πÇ‡∏¢‡∏á', '5': '‡∏™‡∏≤‡∏Ç‡∏≤ 5 ‡∏ó‡πà‡∏≤‡∏Å‡∏•‡∏≤‡∏á', '6': '‡∏™‡∏≤‡∏Ç‡∏≤ 6 ‡∏£‡∏±‡∏©‡∏é‡∏≤', '7': '‡∏™‡∏≤‡∏Ç‡∏≤ 7 ‡∏£‡∏±‡∏Å‡∏©‡πå‡∏à‡∏±‡∏ô‡∏ó‡∏ô‡πå', '8': '‡∏™‡∏≤‡∏Ç‡∏≤ 8 ‡∏´‡∏ô‡πâ‡∏≤ ‡∏£‡∏£.‡∏™‡∏†‡∏≤‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ', '9': '‡∏™‡∏≤‡∏Ç‡∏≤ 9 ‡∏´‡∏ô‡πâ‡∏≤ ‡∏ö‡∏¥‡πä‡∏Å‡∏ã‡πä' };
        const fullBranchNameMap = { '1': '‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏≤ ‡∏°‡∏≠ ‡∏≠‡∏≠', '2': '‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏≤ ‡∏°‡∏≠ ‡∏≠‡∏≠ 2', '3': '‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏≤ ‡∏°‡∏≠ ‡∏≠‡∏≠ 3', '4': '‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏≤ ‡∏°‡∏≠ ‡∏≠‡∏≠ 4', '5': '‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏≤ ‡∏°‡∏≠ ‡∏≠‡∏≠ ‡∏ó‡πà‡∏≤‡∏Å‡∏•‡∏≤‡∏á', '6': '‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏≤ ‡∏°‡∏≠ ‡∏≠‡∏≠ ‡∏™‡∏≤‡∏Ç‡∏≤‡∏£‡∏±‡∏©‡∏é‡∏≤', '7': '‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏≤ ‡∏°‡∏≠ ‡∏≠‡∏≠ ‡∏™‡∏≤‡∏Ç‡∏≤‡∏£‡∏±‡∏Å‡∏©‡πå‡∏à‡∏±‡∏ô‡∏ó‡∏ô‡πå', '8': '‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏≤ ‡∏°‡∏≠ ‡∏≠‡∏≠ ‡∏™‡∏≤‡∏Ç‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏†‡∏≤‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ', '9': '‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏≤ ‡∏°‡∏≠ ‡∏≠‡∏≠ ‡∏™‡∏≤‡∏Ç‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏¥‡πä‡∏Å‡∏ã‡∏µ' };
        
        const chiefComplaintsOptions = [
            { value: '(01) Dizziness', label: 'Dizziness (‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏®‡∏µ‡∏£‡∏©‡∏∞)' }, { value: '(02) Headache', label: 'Headache (‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß)' },
            { value: '(03) Pain in joint/muscle pain', label: '‡∏õ‡∏ß‡∏î‡∏Ç‡πâ‡∏≠/‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠' }, { value: '(04) Toothache', label: 'Toothache (‡∏õ‡∏ß‡∏î‡∏ü‡∏±‡∏ô)' },
            { value: '(05) Abdominal pain (Menstrual)', label: '‡∏õ‡∏ß‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' }, { value: '(06) Stomachache', label: 'Stomachache (‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á)' },
            { value: '(07) Diarrhea', label: 'Diarrhea (‡∏ó‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢)' }, { value: '(08) Constipation/Hemorrhoids', label: '‡∏ó‡πâ‡∏≠‡∏á‡∏ú‡∏π‡∏Å/‡∏£‡∏¥‡∏î‡∏™‡∏µ‡∏î‡∏ß‡∏á‡∏ó‡∏ß‡∏≤‡∏£' },
            { value: '(09) Dysuria', label: 'Dysuria (‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡πÅ‡∏™‡∏ö‡∏Ç‡∏±‡∏î)' }, { value: '(10) Vaginal discharge', label: 'Vaginal discharge (‡∏ï‡∏Å‡∏Ç‡∏≤‡∏ß)' },
            { value: '(11) Wound', label: 'Wound (‡πÅ‡∏ú‡∏•)' }, { value: '(12) Skin rash', label: 'Skin rash (‡∏ú‡∏∑‡πà‡∏ô‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á)' },
            { value: '(13) Eye disorder', label: 'Eye disorder (‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏ï‡∏≤)' }, { value: '(14) Ear disorder', label: 'Ear disorder (‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏´‡∏π)' },
            { value: '(15) Fever/cough/sore throat', label: '‡πÑ‡∏Ç‡πâ ‡πÑ‡∏≠ ‡πÄ‡∏à‡πá‡∏ö‡∏Ñ‡∏≠' }, { value: '(16) Covid-19', label: 'Covid-19 (‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÇ‡∏Ñ‡∏ß‡∏¥‡∏î)' },
            { value: '(17) Rhinorrhea/ nasal congestion', label: '‡∏ô‡πâ‡∏≥‡∏°‡∏π‡∏Å ‡∏Ñ‡∏±‡∏î‡∏à‡∏°‡∏π‡∏Å' }, { value: '(18) Ulcer in mouth', label: 'Ulcer in mouth (‡πÅ‡∏ú‡∏•‡πÉ‡∏ô‡∏õ‡∏≤‡∏Å)' },
            { value: '(19) Herpes simplex', label: 'Herpes simplex (‡∏ï‡∏∏‡πà‡∏°‡∏ô‡πâ‡∏≥‡πÉ‡∏™‡∏ó‡∏µ‡πà‡∏õ‡∏≤‡∏Å)' }, { value: '(20) Burn', label: 'Burn (‡πÅ‡∏ú‡∏•‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô‡∏•‡∏ß‡∏Å)' },
            { value: '(21) Itchy skin/head', label: '‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏ô‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á/‡∏®‡∏µ‡∏£‡∏©‡∏∞' }, { value: '(22) Helminthiasis', label: 'Helminthiasis (‡∏û‡∏¢‡∏≤‡∏ò‡∏¥)' },
            { value: '(23) Scabies', label: 'Scabies (‡∏´‡∏¥‡∏î ‡πÄ‡∏´‡∏≤)' }, { value: '(24) Cellulitis', label: 'Cellulitis (‡∏ù‡∏µ ‡∏´‡∏ô‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á)' },
            { value: '(25) Beriberi', label: 'Beriberi (‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ä‡∏≤/‡πÄ‡∏´‡∏ô‡πá‡∏ö‡∏ä‡∏≤)' }, { value: '(26) Insomnia', label: 'Insomnia (‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏±‡∏ö)' },
            { value: '(27) Motion sickness', label: 'Motion sickness (‡πÄ‡∏°‡∏≤‡∏£‡∏ñ ‡πÄ‡∏°‡∏≤‡πÄ‡∏£‡∏∑‡∏≠)' }, { value: '(28) Anorexia', label: 'Anorexia (‡πÄ‡∏ö‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£)' },
            { value: '(29) Nausea and vomitting', label: '‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏™‡πâ ‡∏≠‡∏≤‡πÄ‡∏à‡∏µ‡∏¢‡∏ô' }, { value: '(30) Drug/food allergy/insect bite', label: '‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤/‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÅ‡∏°‡∏•‡∏á‡∏Å‡∏±‡∏î‡∏ï‡πà‡∏≠‡∏¢' },
            { value: '(31) Tobacco dependence', label: '‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà' }, { value: '(32) Gingivitis', label: '‡πÄ‡∏´‡∏á‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö/‡∏°‡∏µ‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏õ‡∏≤‡∏Å' }, { value: '(33) Others', label: '‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ' }
        ];

        // --- UTILS ---
        const getFirestoreCompat = () => firebase.firestore();
        const getAuthCompat = () => firebase.auth();
        const getCollectionCompat = (db, ...path) => db.collection(path.join('/'));
        const getDocCompat = (db, ...path) => db.doc(path.join('/'));
        const serverTimestampCompat = firebase.firestore.FieldValue.serverTimestamp;

        const LoadingSpinner = () => (
            <div className="flex flex-col justify-center items-center p-12">
                <div className="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent mb-4"></div>
                <p className="text-blue-700 font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</p>
            </div>
        );

        // --- HOOKS ---
        const useFirebase = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            useEffect(() => {
                try {
                    firebase.initializeApp(USER_FIREBASE_CONFIG);
                    const firestore = getFirestoreCompat();
                    const authInstance = getAuthCompat();
                    setDb(firestore); setAuth(authInstance);
                    const unsubscribe = authInstance.onAuthStateChanged(async (user) => {
                        if (!user) await authInstance.signInAnonymously();
                        setUserId(authInstance.currentUser.uid);
                        setIsAuthReady(true);
                    });
                    return () => unsubscribe();
                } catch (e) { setIsAuthReady(true); }
            }, []);
            return { db, auth, userId, isAuthReady };
        };

        const useCaseData = (db, isAuthReady) => {
            const [cases, setCases] = useState([]);
            const [loading, setLoading] = useState(true);
            useEffect(() => {
                if (!db || !isAuthReady) return;
                const unsubscribe = getCollectionCompat(db, 'artifacts', FIREBASE_PATH_APP_ID, 'public/data/cases')
                    .orderBy('timestamp', 'desc')
                    .onSnapshot((snapshot) => {
                        setCases(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), timestamp: doc.data().timestamp?.toDate ? doc.data().timestamp.toDate().toLocaleDateString('th-TH') : 'N/A' })));
                        setLoading(false);
                    }, () => setLoading(false));
                return () => unsubscribe();
            }, [db, isAuthReady]);
            return { cases, loading };
        };

        // --- COMPONENTS ---
        
        // 1. Footer
        const Footer = () => {
            const [currentTime, setCurrentTime] = useState(new Date());
            useEffect(() => { const timer = setInterval(() => setCurrentTime(new Date()), 1000); return () => clearInterval(timer); }, []);
            return (
                <footer className="mt-12 py-6 border-t no-print bg-white text-center text-sm text-gray-500 shadow-inner">
                    <div className="max-w-7xl mx-auto px-4">
                        <p className="font-medium">CMO-Case Management System (Powered by React & Firebase)</p>
                        <p className="text-xs mt-1 text-gray-400">Develop by Opioid.Apisit | {currentTime.toLocaleString('th-TH')}</p>
                    </div>
                </footer>
            );
        };

        // 2. Menu Card (Clean Style - No Emoji, Colored Box)
        const MenuCard = ({ title, icon, color, onClick, href }) => {
            const content = (
                <div className="menu-card group">
                    <div className="icon-box" style={{backgroundColor: color}}>
                        <i className={`fa-solid ${icon}`}></i>
                    </div>
                    <span className="menu-title group-hover:text-blue-600 transition-colors">{title}</span>
                </div>
            );
            return href ? <a href={href} target="_blank" rel="noopener noreferrer" className="block h-full">{content}</a> : <div onClick={onClick} className="h-full block">{content}</div>;
        };

        // 3. Referral Report Body (Shared for Print)
        const renderReportBody = (caseData, getCurrentDate, treatmentBoxChecked, elementId) => (
            <div id={elementId} className="p-8 font-kanit text-gray-900 bg-white" style={{ maxWidth: '210mm', margin: '0 auto', fontSize: '10pt', border: 'none' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '5px' }}>
                    <img src={LOGO_BASE_URL} alt="Header Logos" style={{ height: 'auto', maxHeight: '40px', display: 'block' }} onError={(e) => { e.target.style.display='none'; }} />
                    <div style={{ fontSize: '10pt' }}><strong>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</strong> {caseData.cid || '...........................................'}</div>
                </div>
                <h2 className="text-lg font-bold text-center mb-2" style={{fontSize: '14pt', margin: '10px 0 15px 0', borderBottom: '1px solid #000', paddingBottom: '5px'}}>
                    ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (Pharmacist Referral Form: PhRF)
                </h2>
                <table className="w-full spsr-table border-collapse border border-gray-900 text-sm" style={{ tableLayout: 'fixed' }}>
                    <tbody>
                        <tr><td colSpan="4" className="border border-gray-900 p-2"><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</strong> {caseData.patient_name} | <strong>‡πÄ‡∏û‡∏®:</strong> {caseData.gender} | <strong>‡∏≠‡∏≤‡∏¢‡∏∏:</strong> {caseData.age} ‡∏õ‡∏µ | <strong>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</strong> {caseData.tel}</td></tr>
                        <tr><td colSpan="4" className="border border-gray-900 p-2"><p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> {caseData.address}</p><p><strong>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•:</strong> {caseData.health_scheme} | <strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠:</strong> {caseData.reason_for_referral}</p></td></tr>
                        <tr><td colSpan="2" className="border border-gray-900 p-2 font-bold" style={{ backgroundColor: '#f0f0f0', textAlign: 'center' }}>‡∏Å‡∏≤‡∏£‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</td><td colSpan="2" className="border border-gray-900 p-2 font-bold" style={{ backgroundColor: '#f0f0f0', textAlign: 'center' }}>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠</td></tr>
                        <tr><td colSpan="2" className="border border-gray-900 p-2 align-top h-40"><div style={{ whiteSpace: 'pre-wrap' }}>{caseData.drug_review || ' - '}</div></td>
                        <td colSpan="2" className="border border-gray-900 p-2 align-top"><p><strong>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</strong> {caseData.chief_complaints}</p><p><strong>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢:</strong> {caseData.history_of_illness}</p><p><strong>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß:</strong> {caseData.chronic_disease}</p><p><strong>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏û‡πâ‡∏¢‡∏≤:</strong> {caseData.drug_allergy}</p><p><strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</strong> {caseData.additional_info}</p><p><strong>‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö:</strong> {caseData.problem_found}</p></td></tr>
                        <tr><td colSpan="4" className="border border-gray-900 p-2 font-bold" style={{ backgroundColor: '#f0f0f0', textAlign: 'center' }}>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£</td></tr>
                        <tr><td colSpan="4" className="border border-gray-900 p-2 align-top">
                            <p>[{treatmentBoxChecked('give_treatment')}] ‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô {caseData.initial_treatment.includes('give_treatment') && caseData.treatment_note && `(**‡∏£‡∏∞‡∏ö‡∏∏: ${caseData.treatment_note}**)`}</p>
                            <p>[{treatmentBoxChecked('give_advice')}] ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤/‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á {caseData.initial_treatment.includes('give_advice') && caseData.advice_note && `(**‡∏£‡∏∞‡∏ö‡∏∏: ${caseData.advice_note}**)`}</p>
                            <p>[{treatmentBoxChecked('other_action')}] ‡∏≠‡∏∑‡πà‡∏ô‡πÜ {caseData.initial_treatment.includes('other_action') && caseData.other_note && `(**‡∏£‡∏∞‡∏ö‡∏∏: ${caseData.other_note}**)`}</p>
                        </td></tr>
                        <tr><td colSpan="4" className="p-4 pt-8 border-gray-900 text-right" style={{ borderTop: 'none', borderBottom: 'none' }}><div style={{ textAlign: 'center', marginTop: '30px' }}><p>(‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠) .....................................................</p><p>‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠: {caseData.pharmacist_name}</p><p>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û: {caseData.license_no} | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {getCurrentDate()}</p></div><div style={{ textAlign: 'left', marginTop: '15px', borderTop: '1px solid #ccc', paddingTop: '5px' }}><p><strong>‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏≤:</strong> {caseData.pharmacy_name} | <strong>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</strong> {caseData.pharmacy_tel}</p><p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏≤:</strong> {caseData.pharmacy_address}</p></div></td></tr>
                        <tr><td colSpan="4" className="p-2 border border-gray-900 header-row" style={{fontSize: '10pt', backgroundColor: '#f0f0f0', textAlign: 'center'}}><p>‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô</p></td></tr>
                    </tbody>
                </table>
            </div>
        );

        // 4. Referral Print View
        const ReferralPrintView = ({ caseData, onEdit, onFinalize }) => {
            const getCurrentDate = () => new Date().toLocaleDateString('th-TH', { day: 'numeric', month: 'numeric', year: 'numeric' });
            const treatmentBoxChecked = (name) => caseData.initial_treatment.includes(name) ? '‚úì' : ''; 
            return (
                <div className="dashboard-container pt-8">
                     <div className="form-section flex justify-between items-center no-print">
                        <h2 className="text-xl font-bold text-gray-800"><i className="fa-solid fa-print mr-2 text-blue-600"></i> ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</h2>
                         <div className="space-x-3">
                            <button onClick={onEdit} className="btn-action btn-gray">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                            <button onClick={onFinalize} className="btn-action btn-green">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
                         </div>
                    </div>
                    <div id="view-area" className="no-print bg-white shadow-lg p-2 rounded overflow-hidden mb-10">
                        {renderReportBody(caseData, getCurrentDate, treatmentBoxChecked, 'view-area-content')}
                    </div>
                    {ReactDOM.createPortal(renderReportBody(caseData, getCurrentDate, treatmentBoxChecked, 'print-area'), document.body)}
                </div>
            );
        };

        // 5. Standard Report Print View
        const StandardReportPrintView = ({ caseData, onHide, onPostPrint }) => {
            useEffect(() => { const timer = setTimeout(() => { window.print(); onPostPrint(); onHide(); }, 500); return () => clearTimeout(timer); }, [onHide, onPostPrint]);
            const formatDate = (ds) => { try { return new Date(ds + 'T00:00:00').toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }); } catch { return ds; } };
            const ccText = (Array.isArray(caseData.chief_complaints) ? caseData.chief_complaints.join('\n') : caseData.chief_complaints?.replace(/; /g, '\n')) || '-';
            let printBranch = fullBranchNameMap[caseData.branch] || branchMap[caseData.branch] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡∏Ç‡∏≤';
            return ReactDOM.createPortal(
                <div id="print-area" className="p-8 font-kanit text-gray-900 bg-white" style={{ maxWidth: '210mm', margin: '0 auto' }}>
                    <h1 className="text-xl font-bold text-center mb-4">‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏≤ ‡∏°‡∏≠ ‡∏≠‡∏≠)</h1>
                    <table className="w-full report-table border-collapse border border-gray-500 text-sm">
                        <thead><tr className="bg-gray-100"><td colSpan="2" className="p-2 border border-gray-500 font-semibold">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: {printBranch}</td><td colSpan="2" className="p-2 border border-gray-500 font-semibold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: {caseData.timestamp}</td></tr></thead>
                        <tbody>
                            <tr><td colSpan="2" className="p-2 border border-gray-500">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•: {caseData.patient_name}</td><td colSpan="2" className="p-2 border border-gray-500">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå: {caseData.tel || '-'}</td></tr>
                            <tr><td className="p-2 border border-gray-500">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å: {caseData.weight || '-'} ‡∏Å‡∏Å.</td><td className="p-2 border border-gray-500">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á: {caseData.height || '-'} ‡∏ã‡∏°.</td><td colSpan="2" className="p-2 border border-gray-500">‡∏≠‡∏≤‡∏¢‡∏∏: {caseData.age || '-'} ‡∏õ‡∏µ</td></tr>
                            <tr><td colSpan="4" className="p-2 border border-gray-500">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß: {caseData.chronic_disease || '-'}</td></tr>
                            <tr><td colSpan="4" className="p-2 border border-gray-500">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤: {caseData.drug_allergy || '-'}</td></tr>
                            <tr className="bg-blue-50"><td colSpan="4" className="p-2 border border-gray-500 font-bold">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2 ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</td></tr>
                            <tr><td colSpan="4" className="p-2 border border-gray-500 h-20 align-top"><span className="font-semibold">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</span><div style={{ whiteSpace: 'pre-wrap' }}>{ccText}</div></td></tr>
                            <tr><td colSpan="4" className="p-2 border border-gray-500 h-20 align-top"><span className="font-semibold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥:</span><div className="whitespace-pre-wrap">{caseData.history || '-'}</div></td></tr>
                            <tr><td colSpan="4" className="p-2 border border-gray-500"><span className="font-semibold">‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô:</span><div>{caseData.diagnosis || '-'}</div></td></tr>
                            <tr><td colSpan="4" className="p-2 border border-gray-500 h-20 align-top"><span className="font-semibold">‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤:</span><div className="whitespace-pre-wrap">{caseData.treatment || '-'}</div></td></tr>
                            <tr className="bg-blue-50"><td colSpan="4" className="p-2 border border-gray-500 font-bold">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3 ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</td></tr>
                            <tr><td colSpan="4" className="p-2 border border-gray-500"><span className="font-semibold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°:</span> {formatDate(caseData.follow_up_date)}</td></tr>
                            <tr><td colSpan="4" className="p-2 border border-gray-500 h-20 align-top"><span className="font-semibold">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°:</span><div className="whitespace-pre-wrap">{caseData.follow_up_result || '-'}</div></td></tr>
                            <tr><td colSpan="4" className="p-4 text-right"><p className="mt-8">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠..................................................</p><p>(‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£/‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô)</p></td></tr>
                        </tbody>
                    </table>
                </div>, document.body
            );
        };

        // 6. Referral Form (New Design)
        const ReferralForm = ({ initialData, onCancel, onSendReport }) => {
            const [formData, setFormData] = useState(initialData || {
                pharmacy_name: fullBranchNameMap['1'], pharmacy_address: '', pharmacy_tel: '', pharmacist_name: '', license_no: '‡∏†.',
                patient_name: '', cid: '', gender: '‡∏ä‡∏≤‡∏¢', age: '', address: '', tel: '', health_scheme: 'UC', reason_for_referral: 'further investigation/management',
                drug_review: '', chief_complaints: '', history_of_illness: '', chronic_disease: '', drug_allergy: '', additional_info: '', problem_found: '',
                initial_treatment: [], treatment_note: '', advice_note: '', other_note: ''
            });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const isEditMode = initialData != null;

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                if (type === 'checkbox') {
                    setFormData(prev => ({ ...prev, initial_treatment: checked ? [...prev.initial_treatment, name] : prev.initial_treatment.filter(n => n !== name) }));
                } else setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.patient_name || !formData.pharmacist_name) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠'); return; }
                setIsSubmitting(true);
                onSendReport(formData, 'referral').finally(() => setIsSubmitting(false));
            };

            return (
                <div className="dashboard-container pt-6">
                    <button onClick={onCancel} className="mb-4 text-gray-500 hover:text-blue-600 font-medium flex items-center transition"><i className="fa-solid fa-arrow-left mr-2"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                    <div className="form-section">
                         <h1 className="text-xl font-bold text-gray-800 mb-6 border-b pb-4"><i className="fa-solid fa-hospital-user mr-2 text-blue-600"></i> ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (‡∏™‡∏õ‡∏™‡∏ä.)</h1>
                         <form onSubmit={handleSubmit}>
                            <div className="bg-blue-50/50 p-6 rounded-xl mb-6 border border-blue-100">
                                <h2 className="font-bold text-blue-700 mb-4">‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label className="text-sm font-semibold text-gray-600">‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠</label><input type="text" name="pharmacist_name" value={formData.pharmacist_name} onChange={handleChange} required className="input-field mt-1"/></div>
                                    <div><label className="text-sm font-semibold text-gray-600">‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏≤</label><select name="pharmacy_name" value={formData.pharmacy_name} onChange={handleChange} className="select-field mt-1">{Object.values(fullBranchNameMap).map(n => <option key={n} value={n}>{n}</option>)}</select></div>
                                    <div><label className="text-sm font-semibold text-gray-600">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û</label><input type="text" name="license_no" value={formData.license_no} onChange={handleChange} className="input-field mt-1"/></div>
                                    <div><label className="text-sm font-semibold text-gray-600">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏≤</label><input type="tel" name="pharmacy_tel" value={formData.pharmacy_tel} onChange={handleChange} className="input-field mt-1"/></div>
                                    <div className="md:col-span-2"><label className="text-sm font-semibold text-gray-600">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏≤</label><textarea name="pharmacy_address" rows="2" value={formData.pharmacy_address} onChange={handleChange} className="textarea-field mt-1"/></div>
                                </div>
                            </div>
                            
                            <h2 className="text-lg font-bold text-gray-700 mt-6 mb-3">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div className="md:col-span-3"><label className="text-sm font-semibold text-gray-600">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label><input type="text" name="patient_name" value={formData.patient_name} onChange={handleChange} required className="input-field mt-1"/></div>
                                <div><label className="text-sm font-semibold text-gray-600">‡πÄ‡∏•‡∏Ç ‡∏õ‡∏ä‡∏ä.</label><input type="text" name="cid" value={formData.cid} onChange={handleChange} maxLength="13" className="input-field mt-1"/></div>
                                <div><label className="text-sm font-semibold text-gray-600">‡πÄ‡∏û‡∏®</label><select name="gender" value={formData.gender} onChange={handleChange} className="select-field mt-1"><option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option><option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option><option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option></select></div>
                                <div><label className="text-sm font-semibold text-gray-600">‡∏≠‡∏≤‡∏¢‡∏∏</label><input type="number" name="age" value={formData.age} onChange={handleChange} className="input-field mt-1"/></div>
                                <div className="md:col-span-2"><label className="text-sm font-semibold text-gray-600">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label><input type="text" name="address" value={formData.address} onChange={handleChange} className="input-field mt-1"/></div>
                                <div><label className="text-sm font-semibold text-gray-600">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="tel" name="tel" value={formData.tel} onChange={handleChange} className="input-field mt-1"/></div>
                                <div className="md:col-span-3"><label className="text-sm font-semibold text-gray-600">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label><select name="health_scheme" value={formData.health_scheme} onChange={handleChange} className="select-field mt-1"><option value="UC">UC</option><option value="‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£">‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</option><option value="‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°</option></select></div>
                                <div className="md:col-span-3"><label className="text-sm font-semibold text-gray-600">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠</label><select name="reason_for_referral" value={formData.reason_for_referral} onChange={handleChange} className="select-field mt-1"><option value="further investigation/management">further investigation/management</option><option value="Drug-related problem">Drug-related problem</option><option value="Loss of follow-up">Loss of follow-up</option></select></div>
                            </div>

                            <h2 className="text-lg font-bold text-gray-700 mt-6 mb-3">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠</h2>
                            <div className="grid gap-4">
                                <div><label className="text-sm font-semibold text-gray-600">‡∏Å‡∏≤‡∏£‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</label><textarea name="drug_review" rows="2" value={formData.drug_review} onChange={handleChange} className="textarea-field mt-1"/></div>
                                <div><label className="text-sm font-semibold text-gray-600">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label><textarea name="chief_complaints" rows="2" value={formData.chief_complaints} onChange={handleChange} required className="textarea-field mt-1"/></div>
                                <div><label className="text-sm font-semibold text-gray-600">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢</label><textarea name="history_of_illness" rows="3" value={formData.history_of_illness} onChange={handleChange} className="textarea-field mt-1"/></div>
                                <div className="grid md:grid-cols-2 gap-4">
                                    <div><label className="text-sm font-semibold text-gray-600">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label><input type="text" name="chronic_disease" value={formData.chronic_disease} onChange={handleChange} className="input-field mt-1"/></div>
                                    <div><label className="text-sm font-semibold text-gray-600">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label><input type="text" name="drug_allergy" value={formData.drug_allergy} onChange={handleChange} className="input-field mt-1"/></div>
                                </div>
                                <div><label className="text-sm font-semibold text-gray-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label><textarea name="additional_info" rows="2" value={formData.additional_info} onChange={handleChange} className="textarea-field mt-1"/></div>
                                <div><label className="text-sm font-semibold text-gray-600">‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö</label><textarea name="problem_found" rows="2" value={formData.problem_found} onChange={handleChange} className="textarea-field mt-1"/></div>
                            </div>

                            <h2 className="text-lg font-bold text-gray-700 mt-6 mb-3">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</h2>
                            <div className="bg-gray-50 p-4 rounded-xl space-y-3">
                                {['give_treatment', 'give_advice', 'other_action'].map(action => (
                                    <div key={action} className="flex flex-col sm:flex-row sm:items-center gap-2">
                                        <div className="flex items-center min-w-[200px]">
                                            <input type="checkbox" name={action} checked={formData.initial_treatment.includes(action)} onChange={handleChange} className="w-5 h-5 accent-blue-600 mr-2"/>
                                            <span className="text-sm font-medium text-gray-700">{action === 'give_treatment' ? '‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô' : action === 'give_advice' ? '‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥' : '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'}</span>
                                        </div>
                                        <input type="text" name={action === 'give_treatment' ? 'treatment_note' : action === 'give_advice' ? 'advice_note' : 'other_note'} value={formData[action === 'give_treatment' ? 'treatment_note' : action === 'give_advice' ? 'advice_note' : 'other_note']} onChange={handleChange} placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..." className="input-field !py-1 flex-grow"/>
                                    </div>
                                ))}
                            </div>

                            <button type="submit" disabled={isSubmitting} className="w-full mt-8 btn-action btn-blue w-full py-4 text-lg">
                                <span className="text-xl mr-2">üñ®Ô∏è</span> {isSubmitting ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...' : '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå (‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠)'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // 7. Case Form (New Design)
        const CaseForm = ({ initialCase, onSave, onCancel, onDelete }) => {
            const [formData, setFormData] = useState(initialCase ? { ...initialCase, chief_complaints: typeof initialCase.chief_complaints === 'string' ? initialCase.chief_complaints.split('; ').filter(Boolean) : initialCase.chief_complaints || [] } : { branch: '1', reporter: '', patient_name: '', tel: '', age: '', weight: '', height: '', chronic_disease: '', drug_allergy: '', chief_complaints: [], history: '', diagnosis: '', treatment: '', follow_up_date: '', follow_up_result: '', status: '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°' });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const isEditMode = initialCase !== null;

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                if (type === 'checkbox') {
                    setFormData(prev => ({ ...prev, chief_complaints: checked ? [...new Set([...prev.chief_complaints, value])] : prev.chief_complaints.filter(c => c !== value) }));
                } else setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e, newStatus = null, shouldDelete = false) => {
                e.preventDefault();
                if (!formData.patient_name || !formData.branch || !formData.reporter || formData.chief_complaints.length === 0) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢, ‡∏™‡∏≤‡∏Ç‡∏≤, ‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç'); return; }
                if (shouldDelete) { onDelete(formData.id); return; }
                if (isSubmitting) return;
                setIsSubmitting(true);
                const finalData = { ...formData, chief_complaints: Array.isArray(formData.chief_complaints) ? formData.chief_complaints.join('; ') : formData.chiefComplaints, status: newStatus || formData.status };
                if (newStatus === '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡πâ‡∏ß') {
                    if(confirm("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡πâ‡∏ß' ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) onSave(finalData, isEditMode, true);
                    else setIsSubmitting(false);
                } else { onSave(finalData, isEditMode); setIsSubmitting(false); }
            };

            return (
                <div className="dashboard-container pt-6">
                    <button onClick={onCancel} className="mb-4 text-gray-500 hover:text-blue-600 font-medium flex items-center transition"><i className="fa-solid fa-arrow-left mr-2"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                    <div className="form-section relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-600 via-blue-400 to-blue-600"></div>
                        <h1 className="text-2xl font-bold text-gray-800 mb-6 border-b pb-4 mt-2">
                             {isEditMode ? `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏Ñ‡∏™: ${formData.patient_name}` : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà'}
                        </h1>
                        <form>
                            <h2 className="text-lg font-bold text-blue-700 mb-3">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2>
                            <div className="grid md:grid-cols-2 gap-4 mb-6 bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                                <div><label className="text-sm font-semibold text-gray-600">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô *</label><select name="branch" value={formData.branch} onChange={handleChange} className="select-field mt-1">{Object.keys(branchMap).map(id => <option key={id} value={id}>{branchMap[id]}</option>)}</select></div>
                                <div><label className="text-sm font-semibold text-gray-600">‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô *</label><input type="text" name="reporter" value={formData.reporter} onChange={handleChange} className="input-field mt-1"/></div>
                            </div>
                            
                            <h2 className="text-lg font-bold text-blue-700 mb-3">2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h2>
                            <div className="grid md:grid-cols-3 gap-4 mb-6">
                                <div className="md:col-span-3"><label className="text-sm font-semibold text-gray-600">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ *</label><input type="text" name="patient_name" value={formData.patient_name} onChange={handleChange} className="input-field mt-1"/></div>
                                <div><label className="text-sm font-semibold text-gray-600">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="tel" name="tel" value={formData.tel} onChange={handleChange} className="input-field mt-1"/></div>
                                <div><label className="text-sm font-semibold text-gray-600">‡∏≠‡∏≤‡∏¢‡∏∏</label><input type="number" name="age" value={formData.age} onChange={handleChange} className="input-field mt-1"/></div>
                                <div><label className="text-sm font-semibold text-gray-600">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</label><input type="number" name="weight" value={formData.weight} onChange={handleChange} className="input-field mt-1"/></div>
                                <div><label className="text-sm font-semibold text-gray-600">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label><input type="number" name="height" value={formData.height} onChange={handleChange} className="input-field mt-1"/></div>
                                <div className="md:col-span-2"><label className="text-sm font-semibold text-gray-600">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label><input type="text" name="chronic_disease" value={formData.chronic_disease} onChange={handleChange} className="input-field mt-1"/></div>
                                <div><label className="text-sm font-semibold text-gray-600">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label><input type="text" name="drug_allergy" value={formData.drug_allergy} onChange={handleChange} className="input-field mt-1"/></div>
                            </div>

                            <h2 className="text-lg font-bold text-blue-700 mb-3">3. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</h2>
                            <div className="grid gap-4 mb-6">
                                <div>
                                    <label className="text-sm font-semibold text-gray-600 mb-2 block">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1) *</label>
                                    <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-3 h-56 overflow-y-auto p-4 border border-gray-200 rounded-xl bg-gray-50">
                                        {chiefComplaintsOptions.map(opt => (
                                            <label key={opt.value} className="flex items-center space-x-2 cursor-pointer p-1 hover:bg-white rounded transition">
                                                <input type="checkbox" name="chief_complaints" value={opt.value} checked={formData.chief_complaints.includes(opt.value)} onChange={handleChange} className="w-4 h-4 accent-blue-600"/>
                                                <span className="text-sm text-gray-700">{opt.label}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                                <div><label className="text-sm font-semibold text-gray-600">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</label><textarea name="history" rows="3" value={formData.history} onChange={handleChange} className="textarea-field mt-1"/></div>
                                <div><label className="text-sm font-semibold text-gray-600">‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢</label><input type="text" name="diagnosis" value={formData.diagnosis} onChange={handleChange} className="input-field mt-1"/></div>
                                <div><label className="text-sm font-semibold text-gray-600">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label><textarea name="treatment" rows="3" value={formData.treatment} onChange={handleChange} className="textarea-field mt-1"/></div>
                            </div>

                            <h2 className="text-lg font-bold text-blue-700 mb-3">4. ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</h2>
                            <div className="grid md:grid-cols-2 gap-4 mb-8 bg-orange-50/50 p-4 rounded-xl border border-orange-100">
                                <div><label className="text-sm font-semibold text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</label><input type="date" name="follow_up_date" value={formData.follow_up_date} onChange={handleChange} className="input-field mt-1"/></div>
                                <div className="md:col-span-2"><label className="text-sm font-semibold text-gray-600">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢)</label><textarea name="follow_up_result" rows="2" value={formData.follow_up_result} onChange={handleChange} className="textarea-field mt-1"/></div>
                            </div>

                            <div className="flex flex-col sm:flex-row gap-3 pt-4 border-t">
                                <button type="button" onClick={(e) => handleSubmit(e, '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°')} disabled={isSubmitting} className="flex-1 btn-action btn-blue">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏û‡∏±‡∏Å‡πÄ‡∏Ñ‡∏™ (‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°)</button>
                                <button type="button" onClick={(e) => handleSubmit(e, '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡πâ‡∏ß')} disabled={isSubmitting} className="flex-1 btn-action btn-green">üñ®Ô∏è ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™ & ‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                                {isEditMode ? 
                                    <button type="button" onClick={(e) => handleSubmit(e, null, true)} disabled={isSubmitting} className="flex-1 btn-action btn-red">üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏Ñ‡∏™</button> :
                                    <button type="button" onClick={onCancel} disabled={isSubmitting} className="flex-1 btn-action btn-gray">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                }
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // 8. Dashboard (Balanced Grid)
        const Dashboard = ({ cases, loading, onAddCase, onEditCase, onReport }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [branchFilter, setBranchFilter] = useState(''); 
            const filteredCases = useMemo(() => {
                let filtered = cases.filter(c => c.patient_name.toLowerCase().includes(searchTerm.toLowerCase()) || (c.tel && c.tel.includes(searchTerm)));
                if (branchFilter) filtered = filtered.filter(c => c.branch === branchFilter);
                return filtered.sort((a, b) => {
                    if (a.status === '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°' && b.status !== '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°') return -1;
                    if (a.status !== '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°' && b.status === '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°') return 1;
                    return (b.timestamp || '').localeCompare(a.timestamp || ''); 
                });
            }, [cases, searchTerm, branchFilter]);
            const pendingCount = filteredCases.filter(c => c.status === '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°').length;

            if (loading) return <LoadingSpinner />;

            return (
                <div className="dashboard-container">
                    {/* Menu Grid - Balanced Size */}
                    <div className="menu-grid">
                        <MenuCard title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà" icon="fa-plus" color="#10b981" onClick={onAddCase} />
                        <MenuCard title="Up ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏™" icon="fa-upload" color="#f43f5e" href={DRIVE_UPLOAD_CASE_URL} />
                        <MenuCard title="‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" icon="fa-ambulance" color="#0ea5e9" onClick={() => onReport('referral')} />
                        <MenuCard title="Up ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠" icon="fa-file-medical" color="#f97316" href={DRIVE_REFERRAL_UPLOAD_URL} />
                        <MenuCard title="‡∏ö‡∏±‡∏ï‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤" icon="fa-id-card" color="#d946ef" href="https://opioidapisit.github.io/NaranjoADR/" />
                    </div>

                    <div className="form-section">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <h2 className="text-xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                            <div className="flex gap-2 w-full md:w-auto">
                                <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡πÄ‡∏ö‡∏≠‡∏£‡πå..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="input-field !py-2 !w-full md:!w-64" />
                                <select value={branchFilter} onChange={(e) => setBranchFilter(e.target.value)} className="select-field !py-2 !w-auto">
                                    <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
                                    {Object.keys(branchMap).map(id => <option key={id} value={id}>{branchMap[id]}</option>)}
                                </select>
                            </div>
                        </div>

                        <div className="flex gap-4 mb-4 text-sm font-medium">
                            <span className="text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏™:</span>
                            <span className="text-orange-700 bg-orange-100 px-3 py-1 rounded-full">‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° ({pendingCount})</span>
                            <span className="text-green-700 bg-green-100 px-3 py-1 rounded-full">‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™ ({filteredCases.length - pendingCount})</span>
                        </div>

                        <div className="overflow-x-auto rounded-lg border border-gray-200">
                            <table className="min-w-full modern-table">
                                <thead>
                                    <tr>
                                        <th>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th className="hidden sm:table-cell">‡∏™‡∏≤‡∏Ç‡∏≤</th> 
                                        <th>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</th>
                                        <th className="hidden lg:table-cell">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                        <th className="text-right"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredCases.length > 0 ? filteredCases.map(c => (
                                        <tr key={c.id} onClick={() => onEditCase(c)} className="cursor-pointer transition">
                                            <td className="font-medium text-gray-900">{c.patient_name}</td>
                                            <td className="text-sm text-gray-500 hidden sm:table-cell">{branchMap[c.branch]}</td> 
                                            <td className="text-sm text-gray-700 truncate max-w-xs">{c.chief_complaints?.split(';')[0]}</td>
                                            <td className="text-sm text-gray-500 hidden lg:table-cell">{c.timestamp}</td>
                                            <td><span className={`px-3 py-1 text-xs font-bold rounded-full ${c.status === '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°' ? 'bg-orange-100 text-orange-800' : 'bg-green-100 text-green-800'}`}>{c.status}</span></td>
                                            <td className="text-right text-blue-600"><i className="fa-solid fa-chevron-right"></i></td>
                                        </tr>
                                    )) : (
                                        <tr><td colSpan="6" className="text-center p-8 text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const { db, userId, isAuthReady } = useFirebase();
            const { cases, loading } = useCaseData(db, isAuthReady);
            const [view, setView] = useState('dashboard');
            const [currentCase, setCurrentCase] = useState(null); 
            const [showPrintView, setShowPrintView] = useState(false); 
            const [isSaving, setIsSaving] = useState(false);
            
            if (!isAuthReady && (!USER_FIREBASE_CONFIG.apiKey || USER_FIREBASE_CONFIG.apiKey === "YOUR_API_KEY")) return <div className="p-12 text-center text-red-500 font-bold">Firebase Config Error</div>;

            const handleSave = async (caseData, isEdit, shouldPrint = false) => {
                if (!db || !userId) { alert('‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°'); return; }
                setIsSaving(true);
                try {
                    let docId = caseData.id;
                    const colRef = getCollectionCompat(db, 'artifacts', FIREBASE_PATH_APP_ID, 'public/data/cases');
                    if (isEdit) {
                        const { id, timestamp, ...dataToUpdate } = caseData; 
                        await getDocCompat(db, 'artifacts', FIREBASE_PATH_APP_ID, 'public/data/cases', caseData.id).update(dataToUpdate);
                    } else {
                        const newDocRef = await colRef.add({ ...caseData, timestamp: serverTimestampCompat(), userId });
                        docId = newDocRef.id;
                    }
                    if (shouldPrint) {
                        triggerAppsScriptRecord({ ...caseData, id: docId, status: '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡πâ‡∏ß' }, isEdit);
                        setCurrentCase(cases.find(c => c.id === docId) || { ...caseData, id: docId, timestamp: new Date().toLocaleDateString('th-TH') });
                        setShowPrintView(true);
                    } else {
                        alert(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏Ñ‡∏™ ${caseData.patient_name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                        setView('dashboard'); setCurrentCase(null);
                    }
                } catch (e) { console.error(e); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'); } finally { setIsSaving(false); }
            };
            
            const triggerAppsScriptRecord = async (caseData, isEdit) => {
                if (APPS_SCRIPT_RECORD_URL.includes('YOUR_DEPLOYED')) return;
                try { await fetch(APPS_SCRIPT_RECORD_URL, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...caseData, isEdit }) }); } 
                catch (e) { alert(`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Firebase ‡πÅ‡∏•‡πâ‡∏ß ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô pdf ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô`); }
            };

            const handleReportSubmission = async (reportData, type) => {
                setIsSaving(false);
                setCurrentCase({ ...reportData, timestamp: new Date().toLocaleDateString('th-TH') }); 
                setView('referral_print'); 
            };
            
            const handleReferralFinalize = () => { window.print(); alert(`‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠! ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ñ‡∏™‡∏ï‡πà‡∏≠‡πÑ‡∏õ`); setView('dashboard'); setCurrentCase(null); };
            
            const handleDelete = async (caseId) => {
                if (!db || !userId) return;
                try { await getDocCompat(db, 'artifacts', FIREBASE_PATH_APP_ID, 'public/data/cases', caseId).delete(); alert('‡∏•‡∏ö‡πÄ‡∏Ñ‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); setView('dashboard'); setCurrentCase(null); } catch (e) { alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
            };
            
            let content;
            if (view === 'new_case' || view === 'edit_case') content = <CaseForm initialCase={currentCase} onSave={handleSave} onCancel={() => { setView('dashboard'); setCurrentCase(null); }} onDelete={handleDelete}/>;
            else if (view === 'referral_form') content = <ReferralForm initialData={currentCase} onCancel={() => {setView('dashboard'); setCurrentCase(null);}} onSendReport={handleReportSubmission}/>;
            else if (view === 'referral_print' && currentCase) content = <ReferralPrintView caseData={currentCase} onEdit={() => setView('referral_form')} onFinalize={handleReferralFinalize}/>;
            else content = <Dashboard cases={cases} loading={loading} onAddCase={() => {setView('new_case'); setCurrentCase(null);}} onEditCase={(c) => { setCurrentCase(c); setView('edit_case'); }} onReport={(type) => type === 'referral' ? setView('referral_form') : alert('‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ADR ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤')}/>;

            return (
                <div>
                     {/* Modern Header with Logo */}
                     <header className="header-section no-print">
                        <div className="header-content">
                            {/* Logo: Fallback if image fails */}
                            <img src={SHOP_LOGO_URL} alt="‡∏ï‡∏£‡∏≤" className="shop-logo" onError={(e) => { e.target.style.display='none'; }} />
                            <div>
                                <h1 className="text-2xl font-bold tracking-tight mb-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h1>
                                <p className="text-blue-100 text-sm opacity-90">‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏≤ ‡∏°‡∏≠ ‡∏≠‡∏≠ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ï‡∏£‡∏±‡∏á</p>
                            </div>
                        </div>
                    </header>

                    {/* Main Content Area */}
                    {content}
                    
                    {/* Overlays */}
                    {showPrintView && currentCase && <StandardReportPrintView caseData={currentCase} onHide={() => setShowPrintView(false)} onPostPrint={() => { setShowPrintView(false); setView('dashboard'); setCurrentCase(null); }} />}
                    {isSaving && <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[100] no-print"><div className="bg-white p-8 rounded-xl shadow-2xl flex flex-col items-center"><LoadingSpinner /><span className="text-gray-800 font-bold mt-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span></div></div>}
                    
                    <Footer />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
