<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏≤ ‡∏°‡∏≠ ‡∏≠‡∏≠ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ï‡∏£‡∏±‡∏á</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Kanit -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Kanit ‡πÄ‡∏õ‡πá‡∏ô Font ‡∏´‡∏•‡∏±‡∏Å */
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom class for Kanit font, used within the React app */
        .font-kanit {
            font-family: 'Kanit', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React and Babel Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script type="text/babel">
        // ======================================================================
        // START of App.jsx Content
        // ======================================================================

        // NOTE: The entire content of App.jsx is embedded here.
        
        const { useState, useEffect, useMemo, useCallback } = React;
        
        // --- Global Firebase Variable Setup ---
        // These are accessed directly by the code below
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // --- Branch and Complaints Data ---
        const branchMap = {
            '1': '‡∏™‡∏≤‡∏Ç‡∏≤ 1 ‡∏ô‡∏≤‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏û‡∏ä‡∏£', '2': '‡∏™‡∏≤‡∏Ç‡∏≤ 2 ‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏á', '3': '‡∏™‡∏≤‡∏Ç‡∏≤ 3 ‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏á',
            '4': '‡∏™‡∏≤‡∏Ç‡∏≤ 4 ‡∏ô‡∏≤‡πÇ‡∏¢‡∏á', '5': '‡∏™‡∏≤‡∏Ç‡∏≤ 5 ‡∏ó‡πà‡∏≤‡∏Å‡∏•‡∏≤‡∏á', '6': '‡∏™‡∏≤‡∏Ç‡∏≤ 6 ‡∏£‡∏±‡∏©‡∏é‡∏≤',
            '7': '‡∏™‡∏≤‡∏Ç‡∏≤ 7 ‡∏£‡∏±‡∏Å‡∏©‡πå‡∏à‡∏±‡∏ô‡∏ó‡∏ô‡πå', '8': '‡∏™‡∏≤‡∏Ç‡∏≤ 8 ‡∏´‡∏ô‡πâ‡∏≤ ‡∏£‡∏£.‡∏™‡∏†‡∏≤‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ', '9': '‡∏™‡∏≤‡∏Ç‡∏≤ 9 ‡∏´‡∏ô‡πâ‡∏≤ ‡∏ö‡∏¥‡πä‡∏Å‡∏ã‡πä'
        };

        const chiefComplaintsOptions = [
            { value: '(01) Dizziness', label: 'Dizziness (‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏®‡∏µ‡∏£‡∏©‡∏∞)' },
            { value: '(02) Headache', label: 'Headache (‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß)' },
            { value: '(03) Pain in joint/muscle pain', label: '‡∏õ‡∏ß‡∏î‡∏Ç‡πâ‡∏≠/‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠' },
            { value: '(04) Toothache', label: 'Toothache (‡∏õ‡∏ß‡∏î‡∏ü‡∏±‡∏ô)' },
            { value: '(05) Abdominal pain (Menstrual)', label: '‡∏õ‡∏ß‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' },
            { value: '(06) Stomachache', label: 'Stomachache (‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á)' },
            { value: '(07) Diarrhea', label: 'Diarrhea (‡∏ó‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢)' },
            { value: '(08) Constipation/Hemorrhoids', label: '‡∏ó‡πâ‡∏≠‡∏á‡∏ú‡∏π‡∏Å/‡∏£‡∏¥‡∏î‡∏™‡∏µ‡∏î‡∏ß‡∏á‡∏ó‡∏ß‡∏≤‡∏£' },
            { value: '(09) Dysuria', label: 'Dysuria (‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡πÅ‡∏™‡∏ö‡∏Ç‡∏±‡∏î)' },
            { value: '(10) Vaginal discharge', label: 'Vaginal discharge (‡∏ï‡∏Å‡∏Ç‡∏≤‡∏ß)' },
            { value: '(11) Wound', label: 'Wound (‡πÅ‡∏ú‡∏•)' },
            { value: '(12) Skin rash', label: 'Skin rash (‡∏ú‡∏∑‡πà‡∏ô‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á)' },
            { value: '(13) Eye disorder', label: 'Eye disorder (‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏ï‡∏≤)' },
            { value: '(14) Ear disorder', label: 'Ear disorder (‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏´‡∏π)' },
            { value: '(15) Fever/cough/sore throat', label: '‡πÑ‡∏Ç‡πâ ‡πÑ‡∏≠ ‡πÄ‡∏à‡πá‡∏ö‡∏Ñ‡∏≠' },
            { value: '(16) Covid-19', label: 'Covid-19 (‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÇ‡∏Ñ‡∏ß‡∏¥‡∏î)' },
            { value: '(17) Rhinorrhea/ nasal congestion', label: '‡∏ô‡πâ‡∏≥‡∏°‡∏π‡∏Å ‡∏Ñ‡∏±‡∏î‡∏à‡∏°‡∏π‡∏Å' },
            { value: '(18) Ulcer in mouth', label: 'Ulcer in mouth (‡πÅ‡∏ú‡∏•‡πÉ‡∏ô‡∏õ‡∏≤‡∏Å)' },
            { value: '(19) Herpes simplex', label: 'Herpes simplex (‡∏ï‡∏∏‡πà‡∏°‡∏ô‡πâ‡∏≥‡πÉ‡∏™‡∏ó‡∏µ‡πà‡∏õ‡∏≤‡∏Å)' },
            { value: '(20) Burn', label: 'Burn (‡πÅ‡∏ú‡∏•‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô‡∏•‡∏ß‡∏Å)' },
            { value: '(21) Itchy skin/head', label: '‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏ô‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á/‡∏®‡∏µ‡∏£‡∏©‡∏∞' },
            { value: '(22) Helminthiasis', label: 'Helminthiasis (‡∏û‡∏¢‡∏≤‡∏ò‡∏¥)' },
            { value: '(23) Scabies', label: 'Scabies (‡∏´‡∏¥‡∏î ‡πÄ‡∏´‡∏≤)' },
            { value: '(24) Cellulitis', label: 'Cellulitis (‡∏ù‡∏µ ‡∏´‡∏ô‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á)' },
            { value: '(25) Beriberi', label: 'Beriberi (‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ä‡∏≤/‡πÄ‡∏´‡∏ô‡πá‡∏ö‡∏ä‡∏≤)' },
            { value: '(26) Insomnia', label: 'Insomnia (‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏±‡∏ö)' },
            { value: '(27) Motion sickness', label: 'Motion sickness (‡πÄ‡∏°‡∏≤‡∏£‡∏ñ ‡πÄ‡∏°‡∏≤‡πÄ‡∏£‡∏∑‡∏≠)' },
            { value: '(28) Anorexia', label: 'Anorexia (‡πÄ‡∏ö‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£)' },
            { value: '(29) Nausea and vomitting', label: '‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏™‡πâ ‡∏≠‡∏≤‡πÄ‡∏à‡∏µ‡∏¢‡∏ô' },
            { value: '(30) Drug/food allergy/insect bite', label: '‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤/‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÅ‡∏°‡∏•‡∏á‡∏Å‡∏±‡∏î‡∏ï‡πà‡∏≠‡∏¢' },
            { value: '(31) Tobacco dependence', label: '‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà' },
            { value: '(32) Gingivitis', label: '‡πÄ‡∏´‡∏á‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö/‡∏°‡∏µ‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏õ‡∏≤‡∏Å' },
        ];
        
        // --- Utility Functions ---
        const getFirestoreCompat = () => firebase.firestore();
        const getAuthCompat = () => firebase.auth();
        const getCollectionCompat = (db, ...path) => db.collection(path.join('/'));
        const getDocCompat = (db, ...path) => db.doc(path.join('/'));
        const serverTimestampCompat = firebase.firestore.FieldValue.serverTimestamp;
        
        // ======================================================================
        // 2. FIREBASE HOOKS & CONTEXT
        // ======================================================================

        const defaultFormData = {
            branch: '1', reporter: '', patient_name: '', tel: '', age: '', weight: '', height: '',
            chronic_disease: '', drug_allergy: '', chief_complaints: [], history: '', diagnosis: '',
            treatment: '', follow_up_date: '', follow_up_result: '', status: '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°',
        };

        const useFirebase = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);

            useEffect(() => {
                if (!firebaseConfig) {
                    console.error("Firebase config is missing.");
                    return;
                }

                try {
                    firebase.initializeApp(firebaseConfig);
                    const firestore = getFirestoreCompat();
                    const authInstance = getAuthCompat();
                    setDb(firestore);
                    setAuth(authInstance);

                    const unsubscribe = authInstance.onAuthStateChanged(async (user) => {
                        if (user) {
                            setUserId(user.uid);
                        } else {
                            try {
                                if (typeof __initial_auth_token !== 'undefined') {
                                    await authInstance.signInWithCustomToken(__initial_auth_token);
                                } else {
                                    await authInstance.signInAnonymously();
                                }
                            } catch (e) {
                                console.error("Firebase Auth Error:", e);
                                await authInstance.signInAnonymously();
                            }
                        }
                        setIsAuthReady(true);
                    });

                    return () => unsubscribe();
                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                }
            }, []);

            return { db, auth, userId, isAuthReady };
        };

        const useCaseData = (db, isAuthReady) => {
            const [cases, setCases] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db || !isAuthReady) return;

                const caseCollectionRef = getCollectionCompat(db, 'artifacts', appId, 'public/data/cases');
                
                // Fetch all data (as requested, filtering is done client-side for simplicity)
                const unsubscribe = caseCollectionRef.onSnapshot((snapshot) => {
                    const caseList = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            // Format timestamp for display (using compat version for date conversion)
                            timestamp: data.timestamp?.toDate ? data.timestamp.toDate().toLocaleDateString('th-TH') : 'N/A',
                        };
                    });
                    setCases(caseList);
                    setLoading(false);
                }, (error) => {
                    console.error("Firestore error:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, isAuthReady]);

            return { cases, loading };
        };


        // ======================================================================
        // 3. COMPONENTS
        // ======================================================================

        // --- A. Case Report Form Component ---
        const CaseForm = ({ initialCase = null, onSave, onCancel, onDelete }) => {
            // No defaultBranchId needed as requested: '‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏£‡∏Å ‡∏ñ‡∏π‡∏Å‡πÅ‡∏•‡πâ‡∏ß'
            const initialData = initialCase ? initialCase : defaultFormData;
                
            const [formData, setFormData] = useState(initialData);
            const isEditMode = initialCase !== null;

            useEffect(() => {
                // When entering Edit Mode (has initialCase)
                if (isEditMode) {
                    if (typeof initialCase.chief_complaints === 'string') {
                        initialCase.chief_complaints = initialCase.chief_complaints.split('; ').filter(Boolean);
                    }
                    setFormData(initialCase);
                }
            }, [initialCase, isEditMode]);

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                
                if (type === 'checkbox') {
                    setFormData(prev => {
                        const updatedComplaints = checked
                            ? [...prev.chief_complaints, value]
                            : prev.chief_complaints.filter(c => c !== value);
                        return { ...prev, chief_complaints: updatedComplaints };
                    });
                } else {
                    setFormData(prev => ({ ...prev, [name]: value }));
                }
            };

            const handleSubmit = (e, newStatus = null, shouldDelete = false) => {
                e.preventDefault();
                
                if (!formData.patient_name || !formData.branch || !formData.reporter || formData.chief_complaints.length === 0) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢, ‡∏™‡∏≤‡∏Ç‡∏≤, ‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç');
                    return;
                }
                
                if (shouldDelete) {
                    onDelete(formData.id);
                    return;
                }

                const finalData = {
                    ...formData,
                    chief_complaints: Array.isArray(formData.chief_complaints) ? formData.chief_complaints.join('; ') : formData.chief_complaints,
                    status: newStatus || formData.status,
                    follow_up_result: newStatus === '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°' ? '' : formData.follow_up_result
                };
                
                onSave(finalData, isEditMode);
            };

            return (
                <main className="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
                    <div className="bg-white p-8 rounded-xl shadow-lg">
                        <h1 className="text-2xl font-semibold text-gray-900 mb-6 border-b pb-2">
                            {isEditMode ? `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏Ñ‡∏™: ${formData.patient_name}` : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà'}
                        </h1>
                        
                        <form onSubmit={(e) => handleSubmit(e)}>
                            {/* --- 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô --- */}
                            <h2 className="text-xl font-bold mb-4 text-indigo-700 border-b pb-2 mt-6">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô <span className="text-red-500">*</span></label>
                                    <select name="branch" value={formData.branch} onChange={handleChange} required
                                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500">
                                        {Object.keys(branchMap).map(id => (
                                            <option key={id} value={id}>{branchMap[id]}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô <span className="text-red-500">*</span></label>
                                    <input type="text" name="reporter" value={formData.reporter} onChange={handleChange} required
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"/>
                                </div>
                            </div>

                            {/* --- 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ --- */}
                            <h2 className="text-xl font-bold mb-4 text-indigo-700 border-b pb-2">2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div className="md:col-span-3">
                                    <label className="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ <span className="text-red-500">*</span></label>
                                    <input type="text" name="patient_name" value={formData.patient_name} onChange={handleChange} required
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                                    <input type="tel" name="tel" value={formData.tel} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏≠‡∏≤‡∏¢‡∏∏</label>
                                    <input type="number" name="age" value={formData.age} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</label>
                                    <input type="number" name="weight" value={formData.weight} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label>
                                    <input type="number" name="height" value={formData.height} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"/>
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label>
                                    <input type="text" name="chronic_disease" value={formData.chronic_disease} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label>
                                    <input type="text" name="drug_allergy" value={formData.drug_allergy} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"/>
                                </div>
                            </div>
                            
                            {/* --- 3. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ --- */}
                            <h2 className="text-xl font-bold mb-4 text-indigo-700 border-b pb-2">3. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</h2>
                            <div className="grid grid-cols-1 gap-6 mb-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1) <span className="text-red-500">*</span></label>
                                    <div id="chief-complaints-list" className="bg-gray-50 p-4 rounded-md border border-gray-300 h-64 overflow-y-auto">
                                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-y-2 gap-x-4">
                                            {chiefComplaintsOptions.map(option => (
                                                <div key={option.value} className="flex items-center">
                                                    <input 
                                                        type="checkbox" 
                                                        name="chief_complaints" 
                                                        value={option.value} 
                                                        checked={formData.chief_complaints.includes(option.value)}
                                                        onChange={handleChange}
                                                        className="rounded text-indigo-600 focus:ring-indigo-500 h-4 w-4 mr-2"
                                                    />
                                                    <span className="text-sm text-gray-800">{option.label}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</label>
                                    <textarea name="history" rows="3" value={formData.history} onChange={handleChange}
                                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢</label>
                                    <input type="text" name="diagnosis" value={formData.diagnosis} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label>
                                    <textarea name="treatment" rows="3" value={formData.treatment} onChange={handleChange}
                                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                                </div>
                            </div>

                            {/* --- 4. ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ --- */}
                            <h2 className="text-xl font-bold mb-4 text-indigo-700 border-b pb-2">4. ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</label>
                                    <input type="date" name="follow_up_date" value={formData.follow_up_date} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"/>
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢)</label>
                                    <textarea name="follow_up_result" rows="2" value={formData.follow_up_result} onChange={handleChange}
                                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                                </div>
                            </div>


                            {/* --- Action Buttons --- */}
                            <div className="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 pt-4 border-t mt-8">
                                
                                {/* 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ñ‡∏™ (‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°) - ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏±‡∏Å‡πÄ‡∏Ñ‡∏™ */}
                                <button type="button" onClick={(e) => handleSubmit(e, '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°')}
                                        className="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out">
                                    <span className="text-lg">üíæ</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏û‡∏±‡∏Å‡πÄ‡∏Ñ‡∏™ (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°)
                                </button>

                                {/* 2. ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™ (‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡πâ‡∏ß) - ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF (Simulated) */}
                                <button type="button" onClick={(e) => handleSubmit(e, '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡πâ‡∏ß')}
                                        className="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out">
                                    <span className="text-lg">‚úÖ</span> ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™ (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡πâ‡∏ß)
                                </button>
                                
                                {/* 3. ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏•‡∏ö‡πÄ‡∏Ñ‡∏™ */}
                                {isEditMode && (
                                     <button type="button" onClick={(e) => {
                                         if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏≤‡∏ß‡∏£')) {
                                             handleSubmit(e, null, true);
                                         }
                                     }}
                                        className="flex-1 bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out">
                                        <span className="text-lg">üóëÔ∏è</span> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏•‡∏ö‡πÄ‡∏Ñ‡∏™
                                     </button>
                                )}
                                 {!isEditMode && (
                                     <button type="button" onClick={onCancel}
                                        className="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out">
                                        <span className="text-lg">‚ùå</span> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å)
                                     </button>
                                 )}
                            </div>
                        </form>
                    </div>
                </main>
            );
        };


        // --- B. Dashboard Component ---
        const Dashboard = ({ cases, loading, onAddCase, onEditCase, onReport }) => {
            
            const [searchTerm, setSearchTerm] = useState('');

            const filteredAndSortedCases = useMemo(() => {
                // 1. Search Filtering
                const lowerCaseSearch = searchTerm.toLowerCase();
                const filtered = cases.filter(c => 
                    c.patient_name.toLowerCase().includes(lowerCaseSearch) ||
                    c.tel.includes(searchTerm)
                );

                // 2. Sorting
                return [...filtered].sort((a, b) => {
                    if (a.status === '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°' && b.status !== '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°') return -1;
                    if (a.status !== '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°' && b.status === '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°') return 1;
                    // Fallback to sort by ID/date if statuses are the same
                    return (b.id || '').localeCompare(a.id || ''); 
                });
            }, [cases, searchTerm]);

            const pendingCount = filteredAndSortedCases.filter(c => c.status === '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°').length;

            if (loading) {
                return <div className="text-center p-12 text-gray-500 font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>;
            }

            return (
                <main className="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
                    <h2 className="text-2xl font-bold mb-4 text-gray-800">
                        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </h2>

                    {/* Header and Action Buttons */}
                    <div className="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 mb-8">
                        <button onClick={onAddCase}
                                className="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition duration-150 ease-in-out">
                            <span className="text-xl">+</span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà
                        </button>
                        <button onClick={() => onReport('refer')}
                                className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg transition duration-150 ease-in-out">
                            ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
                        </button>
                        <button onClick={() => onReport('adr')}
                                className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg transition duration-150 ease-in-out">
                            ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏û‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå
                        </button>
                    </div>

                    {/* Search and Filter Bar */}
                    <div className="bg-white p-6 rounded-xl shadow-lg mb-8">
                        <div className="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
                            <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠, ‡∏™‡∏Å‡∏∏‡∏•, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå..."
                                   value={searchTerm}
                                   onChange={(e) => setSearchTerm(e.target.value)}
                                   className="flex-grow border border-gray-300 rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500 text-lg"/>
                            <button className="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg w-full sm:w-auto transition duration-150 ease-in-out">
                                ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                            </button>
                        </div>
                        
                        {/* Status Indicator */}
                        <div className="mt-4 flex space-x-4 text-sm font-medium">
                            <span className="text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏™:</span>
                            <span className="text-indigo-600">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({filteredAndSortedCases.length})</span>
                            <span className="text-orange-600">‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° ({pendingCount})</span>
                        </div>
                    </div>

                    {/* Case List Table */}
                    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th className="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider hidden sm:table-cell">‡∏™‡∏≤‡∏Ç‡∏≤</th>
                                        <th className="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</th>
                                        <th className="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider hidden lg:table-cell">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</th>
                                        <th className="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                        <th className="px-6 py-4 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">‡∏î‡∏π/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredAndSortedCases.length > 0 ? (
                                        filteredAndSortedCases.map(c => {
                                            const statusClass = c.status === '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°' 
                                                ? 'bg-orange-100 text-orange-800' 
                                                : 'bg-green-100 text-green-800';

                                            return (
                                                <tr key={c.id} className="hover:bg-indigo-50/50 cursor-pointer">
                                                    <td className="px-6 py-4 whitespace-nowrap font-medium text-gray-900">
                                                        {c.patient_name}
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">{branchMap[c.branch] || '-'}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{c.chief_complaints?.split(';')[0] || 'N/A'}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden lg:table-cell">{c.timestamp}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap">
                                                        <span className={`px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}`}>
                                                            {c.status}
                                                        </span>
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                        <button onClick={() => onEditCase(c)} className="text-indigo-600 hover:text-indigo-900">‡∏î‡∏π/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                                    </td>
                                                </tr>
                                            );
                                        })
                                    ) : (
                                        <tr>
                                            <td colSpan="6" className="text-center p-8 text-gray-500">
                                                {!searchTerm ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏™‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö' : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤'}
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </main>
            );
        };


        // --- C. Main Application Component (App) ---
        function App() {
            const { db, userId, isAuthReady } = useFirebase();
            const { cases, loading } = useCaseData(db, isAuthReady);
            
            const [view, setView] = useState('dashboard');
            const [currentCase, setCurrentCase] = useState(null); 

            const handleSave = async (caseData, isEdit) => {
                if (!db || !userId) {
                    alert('‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
                    return;
                }

                const caseCollectionRef = getCollectionCompat(db, 'artifacts', appId, 'public/data/cases');

                try {
                    if (isEdit) {
                        const docRef = getDocCompat(db, 'artifacts', appId, 'public/data/cases', caseData.id);
                        const { id, timestamp, ...dataToUpdate } = caseData; 
                        await docRef.update(dataToUpdate);
                        alert(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏Ñ‡∏™ ${caseData.patient_name} ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "${caseData.status}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                    } else {
                        await caseCollectionRef.add({
                            ...caseData,
                            timestamp: serverTimestampCompat(),
                            userId: userId, 
                        });
                        alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà ${caseData.patient_name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                    }
                    setView('dashboard');
                    setCurrentCase(null);
                } catch (e) {
                    console.error("Error saving case:", e);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console');
                }
            };

            const handleDelete = async (caseId) => {
                if (!db || !userId) return;

                try {
                    const docRef = getDocCompat(db, 'artifacts', appId, 'public/data/cases', caseId);
                    await docRef.delete();
                    alert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏•‡∏ö‡πÄ‡∏Ñ‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    setView('dashboard');
                    setCurrentCase(null);
                } catch (e) {
                    console.error("Error deleting case:", e);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏Ñ‡∏™');
                }
            };
            
            if (!isAuthReady || !db) {
                return <div className="text-center p-12 text-indigo-700 font-bold text-xl">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö Firebase...</div>;
            }

            let content;
            if (view === 'new_case' || view === 'edit_case') {
                content = (
                    <CaseForm 
                        initialCase={currentCase} 
                        onSave={handleSave} 
                        onCancel={() => { setView('dashboard'); setCurrentCase(null); }} 
                        onDelete={handleDelete}
                    />
                );
            } else { // 'dashboard' view
                content = (
                    <Dashboard 
                        cases={cases} 
                        loading={loading} 
                        onAddCase={() => setView('new_case')} 
                        onEditCase={(c) => { setCurrentCase(c); setView('edit_case'); }}
                        onReport={(type) => alert(`‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ${type === 'refer' ? '‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢' : '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ADR'} ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á`)}
                    />
                );
            }

            return (
                <div className="min-h-screen bg-gray-100 font-kanit">
                    <header className="bg-white shadow-md sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-col justify-center items-center text-center">
                            <h1 className="text-3xl font-semibold text-gray-900 tracking-tight">
                                ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏≤ ‡∏°‡∏≠ ‡∏≠‡∏≠ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ï‡∏£‡∏±‡∏á
                            </h1>
                            <div className="text-xs text-gray-500 mt-1">User ID: {userId}</div>
                        </div>
                    </header>
                    {content}
                    <footer className="mt-12 text-center text-gray-500 text-sm py-4 border-t">
                        Case Management System (Powered by React &amp; Firebase)
                    </footer>
                </div>
            );
        }

        // --- ReactDOM Render ---
        const domContainer = document.getElementById('root');
        const root = ReactDOM.createRoot(domContainer);
        root.render(<App />);

        // ======================================================================
        // END of App.jsx Content
        // ======================================================================
    </script>
</body>
</html>
